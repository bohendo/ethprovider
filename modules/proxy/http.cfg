global
  log stdout local0
  maxconn 50000
  tune.ssl.default-dh-param 2048

defaults
  log global
  mode http
  option dontlognull
  option http-server-close
  option httpclose
  option httplog
  option redispatch
  timeout client  300000  # 5 minutes
  timeout connect 3000    # 3 seconds
  timeout server  300000  # 5 minutes

frontend public_http
  acl eth1_path path_beg "/1/$ETH_API_KEY"
  acl eth1_ws_path path_beg "/1/ws/$ETH_API_KEY"
  acl eth2_path path_beg "/2/$ETH_API_KEY"
  acl eth2_ws_path path_beg "/2/ws/$ETH_API_KEY"
  bind *:80
  http-response del-header Access-Control-Allow-Headers
  http-response del-header Access-Control-Allow-Methods
  http-response del-header Access-Control-Allow-Origin
  http-response add-header Access-Control-Allow-Headers "*"
  http-response add-header Access-Control-Allow-Methods "*"
  http-response add-header Access-Control-Allow-Origin "*"
  option forwardfor
  use_backend eth1 if eth1_path
  use_backend eth1_ws if eth1_ws_path
  use_backend eth2 if eth2_path
  use_backend eth2_ws if eth2_ws_path

backend eth1
  http-request replace-path "/1/$ETH_API_KEY" "/"
  server eth1 "$ETH_1_HTTP"

backend eth1_ws
  http-request replace-path "/1/ws/$ETH_API_KEY" "/"
  server eth1 "$ETH_1_WS"

backend eth2
  http-request replace-path "/2/$ETH_API_KEY" "/eth/v1/beacon"
  server eth2 "$ETH_2_HTTP"

backend eth2_ws
  http-request replace-path "/2/ws/$ETH_API_KEY" "/eth/v1/beacon"
  server eth2 "$ETH_2_WS"
